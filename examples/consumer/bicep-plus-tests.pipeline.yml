# Example Bicep deploy plus post-deploy Pester tests

parameters:
  # Global flags
  - name: enableProduction
    displayName: "Enable production"
    type: boolean
    default: false
  - name: drInvocation
    displayName: "Invoke disaster recovery"
    type: boolean
    default: false

  # Pipeline-level controls
  - name: doNotRunReviewStage
    displayName: "Skip review stage"
    type: boolean
    default: false

  # Bicep action group toggles
  - name: doNotRunBicepActions
    displayName: "Skip all Bicep actions"
    type: boolean
    default: false
  - name: doNotRunResourceGroup
    displayName: "Skip Resource Group action"
    type: boolean
    default: false
  - name: doNotRunBase
    displayName: "Skip Base action"
    type: boolean
    default: false

  # Bicep test toggles & settings
  - name: doNotRunBicepTests
    displayName: "Skip all Bicep tests"
    type: boolean
    default: false
  - name: doNotRunRegression
    displayName: "Skip regression tests"
    type: boolean
    default: false
  - name: doNotRunSmoke
    displayName: "Skip smoke tests"
    type: boolean
    default: false
  - name: bicepTestsDelayMinutes
    displayName: "Delay Bicep tests start (minutes)"
    type: number
    default: 0
    values:
      - 0
      - 5
      - 15
      - 30
      - 45
      - 60

  # Operational flags
  - name: allowDeleteOnUnmanage
    displayName: "Allow delete on unmanage (temporary)"
    type: boolean
    default: false
  - name: cleanupResourceGroupStack
    displayName: "Cleanup resource group stack"
    type: boolean
    default: false

  # Environment skips
  - name: skip_dev
    displayName: "Skip environment: Development"
    type: boolean
    default: false
  - name: skip_qa
    displayName: "Skip environment: QA"
    type: boolean
    default: true
  - name: skip_preprod
    displayName: "Skip environment: Pre-Production"
    type: boolean
    default: true

extends:
  template: bicep-plus-tests.settings.yml
  parameters:
    enableProduction: ${{ parameters.enableProduction }}
    runReviewStage: ${{ not(parameters.doNotRunReviewStage) }}
    drInvocation: ${{ parameters.drInvocation }}
    skip_dev: ${{ parameters.skip_dev }}
    skip_qa: ${{ parameters.skip_qa }}
    skip_preprod: ${{ parameters.skip_preprod }}
    actionGroups:
      - name: bicep_actions
        #displayName: Bicep Actions
        enabled: ${{ not(parameters.doNotRunBicepActions) }}
        type: bicep
        tokenReplaceEnabled: true
        # tokenTargetPatterns:
        #   - examples/assets/bicep/**/*.bicepparam
        actions:
          - name: resource_group
            enabled: ${{ not(parameters.doNotRunResourceGroup) }}
            scope: subscription
            resourceGroupName: $(resourceGroup)
            location: $(region)
            #tokenReplaceEnabled: true
            allowDeleteOnUnmanage: ${{ parameters.allowDeleteOnUnmanage}}
            cleanupStack: ${{ parameters.cleanupResourceGroupStack }}
            templatePath: examples/assets/bicep/resourcegroup.bicep
            parametersFile: examples/assets/bicep/resourcegroup.bicepparam
          - name: base
            enabled: ${{ not(parameters.doNotRunBase) }}
            scope: resourceGroup
            resourceGroupName: $(resourceGroup)
            location: $(region)
            #tokenReplaceEnabled: true
            allowDeleteOnUnmanage: ${{ parameters.allowDeleteOnUnmanage }}
            templatePath: examples/assets/bicep/base.bicep
            parametersFile: examples/assets/bicep/base.bicepparam
      - name: bicep_tests
        #displayName: Pester Bicep Tests
        enabled: ${{ not(parameters.doNotRunBicepTests) }}
        type: powershell
        scriptTask: azureCli
        runPowerShellReview: true
        delayMinutes: ${{ parameters.bicepTestsDelayMinutes }}
        ${{ if not(parameters.doNotRunBicepActions) }}:
          dependsOn:
            - bicep_actions
        actions:
          - name: regression
            enabled: ${{ not(parameters.doNotRunRegression) }}
            scriptPath: examples/assets/scripts/pester_run.ps1
            arguments: "-TestsPath examples/assets/tests/pester/regression -ResultsFile TestResults/pester.regression.xml"
            #reviewDisplayName: Regression Pester Preview
            reviewScriptPath: examples/assets/scripts/pester_review.ps1
            reviewArguments: "-TestsPath examples/assets/tests/pester/regression -ResultsFile TestResults/pester.regression.xml"
          - name: smoke
            enabled: ${{ not(parameters.doNotRunSmoke) }}
            scriptPath: examples/assets/scripts/pester_run.ps1
            arguments: "-TestsPath examples/assets/tests/pester/smoke -ResultsFile TestResults/pester.smoke.xml"
            #reviewDisplayName: Smoke Pester Preview
            reviewScriptPath: examples/assets/scripts/pester_review.ps1
            reviewArguments: "-TestsPath examples/assets/tests/pester/smoke -ResultsFile TestResults/pester.smoke.xml"
