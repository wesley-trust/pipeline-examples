# Example Bicep deploy plus post-deploy Pester tests

parameters:
  - name: enableProduction
    type: boolean
    default: false
  - name: runReviewStage
    type: boolean
    default: false
  - name: drInvocation
    type: boolean
    default: false
  - name: skip_dev
    type: boolean
    default: false
  - name: skip_qa
    type: boolean
    default: true
  - name: skip_preprod
    type: boolean
    default: true
  - name: allowDeleteOnUnmanage
    type: boolean
    default: false

extends:
  template: bicep-plus-tests.settings.yml
  parameters:
    enableProduction: ${{ parameters.enableProduction }}
    runReviewStage: ${{ parameters.runReviewStage }}
    drInvocation: ${{ parameters.drInvocation }}
    skip_dev: ${{ parameters.skip_dev }}
    skip_qa: ${{ parameters.skip_qa }}
    skip_preprod: ${{ parameters.skip_preprod }}
    actionGroups:
      - name: bicep_action
        type: bicep
        displayName: Bicep Action
        # tokenTargetPatterns:
        #   - examples/assets/bicep/**/*.bicepparam
        actions:
          - name: resourcegroup
            scope: subscription
            tokenReplaceEnabled: true
            resourceGroupName: $(resourceGroup)
            location: $(region)
            allowDeleteOnUnmanage: ${{ parameters.allowDeleteOnUnmanage}}
            templatePath: examples/assets/bicep/resourcegroup.bicep
            parametersFile: examples/assets/bicep/resourcegroup.bicepparam
          - name: base
            scope: resourceGroup
            tokenReplaceEnabled: true
            resourceGroupName: $(resourceGroup)
            location: $(region)
            allowDeleteOnUnmanage: ${{ parameters.allowDeleteOnUnmanage }}
            templatePath: examples/assets/bicep/base.bicep
            parametersFile: examples/assets/bicep/base.bicepparam
      # - name: bicep_base
      #   type: bicep
      #   displayName: Base
      #   tokenTargetPatterns:
      #     - examples/assets/bicep/**/*.bicepparam
      #   actions:
      #     - name: base
      #       scope: resourceGroup
      #       tokenReplaceEnabled: true
      #       resourceGroupName: $(resourceGroup)
      #       location: $(region)
      #       templatePath: examples/assets/bicep/base.bicep
      #       parametersFile: examples/assets/bicep/base.bicepparam
      # - name: pester_regression
      #   type: powershell
      #   displayName: Pester Regression
      #   dependsOn:
      #     - bicep_action
      #   actions:
      #     - name: regression
      #       scriptPath: examples/assets/scripts/pester_run.ps1
      #       arguments: "-TestsPath examples/assets/tests/pester/regression -ResultsFile TestResults/pester.regression.xml"
      # - name: pester_smoke
      #   type: powershell
      #   displayName: Pester Smoke
      #   dependsOn:
      #     - bicep_action
      #   actions:
      #     - name: smoke
      #       scriptPath: examples/assets/scripts/pester_run.ps1
      #       arguments: "-TestsPath examples/assets/tests/pester/smoke -ResultsFile TestResults/pester.smoke.xml"
